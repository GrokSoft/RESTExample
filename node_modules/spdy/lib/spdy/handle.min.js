var assert=require("assert"),thing=require("handle-thing"),httpDeceiver=require("http-deceiver"),util=require("util");function Handle(a,b,d){var c={};this._spdyState=c;c.options=a||{};c.stream=b;c.socket=null;c.rawSocket=d||b.connection.socket;c.deceiver=null;c.ending=!1;var e=this;thing.call(this,b,{getPeerName:function(){return e._getPeerName()},close:function(a){return e._closeCallback(a)}});if(!c.stream)this.on("stream",function(a){c.stream=a})}util.inherits(Handle,thing);module.exports=Handle;
Handle.create=function(a,b,d){return new Handle(a,b,d)};Handle.prototype._getPeerName=function(){var a=this._spdyState;return a.rawSocket._getpeername?a.rawSocket._getpeername():null};Handle.prototype._closeCallback=function(a){var b=this._spdyState;b.ending?b.stream.end(a):b.stream.abort(a);b.ending=!1};Handle.prototype.getStream=function(a){var b=this._spdyState;if(!a)return assert(b.stream),b.stream;if(b.stream)process.nextTick(function(){a(b.stream)});else this.on("stream",a)};
Handle.prototype.assignSocket=function(a,b){function d(a){c.socket.emit("error",a)}var c=this._spdyState;c.socket=a;c.deceiver=httpDeceiver.create(a,b);this.getStream(function(a){a.on("error",d)})};
Handle.prototype.assignClientRequest=function(a){var b=this._spdyState,d=a.end,c=a._send,e=this;"modern"!==thing.mode&&(a.end=function(){this.end=d;this._send("");return this.end.apply(this,arguments)});a._send=function(d){this._headerSent=!0;this._header="ignore me";this.connection=b.socket;e.getStream(function(a){a.send()});e.emit("needStream");a._send=c;if("GET"!==a.method||0!==d.length)return a._send.apply(this,arguments)};a.useChunkedEncodingByDefault=!1;a.on("finish",function(){a.socket.end()})};
Handle.prototype.assignRequest=function(a){this.getStream(function(b){b.on("headers",function(b){a.emit("trailers",b)})})};Handle.prototype.assignResponse=function(a){var b=this;a.addTrailers=function(a){b.getStream(function(b){b.sendHeaders(a)})}};
Handle.prototype._transformHeaders=function(a,b){var d=this._spdyState,c={},e=Object.keys(b);"request"===a&&d.options["x-forwarded-for"]&&(d=d.stream.connection.getXForwardedFor(),null!==d&&(c["x-forwarded-for"]=d));for(d=0;d<e.length;d++){var f=e[d],g=b[f];":authority"===f&&(c.host=g);/^:/.test(f)||(c[f]=g)}return c};Handle.prototype.emitRequest=function(){var a=this._spdyState,b=a.stream;a.deceiver.emitRequest({method:b.method,path:b.path,headers:this._transformHeaders("request",b.headers)})};
Handle.prototype.emitResponse=function(a,b){this._spdyState.deceiver.emitResponse({status:a,headers:this._transformHeaders("response",b)})}; //# sourceMappingURL=handle.js.map
