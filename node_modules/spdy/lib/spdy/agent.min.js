var assert=require("assert"),http=require("http"),https=require("https"),net=require("net"),util=require("util"),transport=require("spdy-transport"),debug=require("debug")("spdy:client"),EventEmitter=require("events").EventEmitter,spdy=require("../spdy"),mode=/^v0\.8\./.test(process.version)?"rusty":/^v0\.(9|10)\./.test(process.version)?"old":/^v0\.12\./.test(process.version)?"normal":"modern",proto={};
function instantiate(a){function b(b){this._init(a,b)}util.inherits(b,a);b.create=function(a){return new b(a)};Object.keys(proto).forEach(function(a){b.prototype[a]=proto[a]});return b}
proto._init=function(a,b){a.call(this,b);var c={};this._spdyState=c;c.host=b.host;c.options=b.spdy||{};c.secure=this instanceof https.Agent;c.fallback=!1;c.createSocket=this._getCreateSocket();c.socket=null;c.connection=null;this.keepAlive=!1;var d=this;this._connect(b,function(b,a){if(b)return d.emit("error",b);c.connection=a;d.emit("_connect")})};
proto._getCreateSocket=function(){var a,b=this.constructor.super_;do{a=b.prototype.createSocket;if(b.super_===EventEmitter||!b.super_)break;b=b.super_}while(!a);a||(a=http.Agent.prototype.createSocket);assert(a,".createSocket() method not found");return a};
proto._connect=function(a,b){function c(a){return b(a)}var d=this._spdyState,e=d.options.protocols||"h2 spdy/3.1 spdy/3 spdy/2 http/1.1 http/1.0".split(" "),f=this.createConnection(util._extend({NPNProtocols:e,ALPNProtocols:e,servername:a.servername||a.host},a));d.socket=f;f.setNoDelay(!0);f.on("error",c);f.on(d.secure?"secureConnect":"connect",function(){f.removeListener("error",c);var a;if((a=d.secure?f.npnProtocol||f.alpnProtocol:d.options.protocol)&&"http/1.1"!==a&&"http/1.0"!==a){debug("connected protocol=%j",
a);var e=transport.connection.create(f,util._extend({protocol:/spdy/.test(a)?"spdy":"http2",isServer:!1},d.options.connection||{}));if("h2"===a)e.start(4);else if("spdy/3.1"===a)e.start(3.1);else if("spdy/3"===a)e.start(3);else if("spdy/2"===a)e.start(2);else{f.destroy();b(Error("Unexpected protocol: "+a));return}void 0!==d.options["x-forwarded-for"]&&e.sendXForwardedFor(d.options["x-forwarded-for"]);b(null,e)}else debug("activating fallback"),f.destroy(),d.fallback=!0})};
proto._createSocket=function(a,b,c){var d=this._spdyState;if(d.fallback)return d.createSocket(a,b);var e=spdy.handle.create(null,null,d.socket);b={handle:e,allowHalfOpen:!0};b=d.secure?new spdy.Socket(d.socket,b):new net.Socket(b);e.assignSocket(b);e.assignClientRequest(a);var f=this;e.once("needStream",function(){if(null===d.connection)f.once("_connect",function(){e.setStream(f._createStream(a,e))});else e.setStream(f._createStream(a,e))});a.on("response",function(a){e.assignRequest(a)});e.assignResponse(a);
a.addListener("newListener",spdy.request.onNewListener);b.readable=!0;b.writable=!0;return c?c(null,b):b};proto.createSocket="modern"===mode||"normal"===mode?proto._createSocket:function(a,b,c,d,e){var f=this._spdyState;return f.fallback?f.createSocket(a,b,c,d,e):this._createSocket(e,{host:b,port:c})};
proto._createStream=function(a,b){var c=this._spdyState,d=this;return c.connection.reserveStream({method:a.method,path:a.path,headers:a._headers,host:c.host},function(a,c){if(a)return d.emit("error",a);c.on("response",function(a,c){b.emitResponse(a,c)})})};proto.close=function(a){var b=this._spdyState;if(null===b.connection)this.once("_connect",function(){this.close(a)});else b.connection.end(a)};exports.Agent=instantiate(https.Agent);exports.PlainAgent=instantiate(http.Agent);
exports.create=function(a,b){"object"===typeof a&&(b=a,a=null);return a?instantiate(a).create(b):b.spdy&&b.spdy.plain?exports.PlainAgent.create(b):exports.Agent.create(b)}; //# sourceMappingURL=agent.js.map
