var assert=require("assert"),https=require("https"),http=require("http"),tls=require("tls"),net=require("net"),util=require("util"),selectHose=require("select-hose"),transport=require("spdy-transport"),debug=require("debug")("spdy:server"),EventEmitter=require("events").EventEmitter,spdy=require("../spdy"),proto={};
function instantiate(b){function a(a,d){this._init(b,a,d)}util.inherits(a,b);a.create=function(c,b){return new a(c,b)};Object.keys(proto).forEach(function(c){a.prototype[c]=proto[c]});return a}
proto._init=function(b,a,c){var d={};this._spdyState=d;d.options=a.spdy||{};var e=d.options.protocols||"h2 spdy/3.1 spdy/3 spdy/2 http/1.1 http/1.0".split(" ");a=util._extend({NPNProtocols:e,ALPNProtocols:e},a);d.secure=this instanceof tls.Server;d.secure?b.call(this,a):b.call(this);this.httpAllowHalfOpen=!0;b=d.secure?"secureConnection":"connection";d.listeners=this.listeners(b).slice();assert(0<d.listeners.length,"Server does not have default listeners");this.removeAllListeners(b);if(d.options.plain)this.on(b,
this._onPlainConnection);else this.on(b,this._onConnection);if(c)this.on("request",c);debug("server init secure=%d",d.secure)};proto._onConnection=function(b){var a;this._spdyState.secure&&(a=b.npnProtocol||b.alpnProtocol);this._handleConnection(b,a)};
proto._handleConnection=function(b,a){var c=this._spdyState;a||(a=c.options.protocol);debug("incoming socket protocol=%j",a);if(!a||"http/1.1"===a||"http/1.0"===a)return debug("to default handler it goes"),this._invokeDefault(b);b.setNoDelay(!0);c=transport.connection.create(b,util._extend({protocol:/spdy/.test(a)?"spdy":"http2",isServer:!0},c.options.connection||{}));"http2"===a?c.start(4):"spdy/3.1"===a?c.start(3.1):"spdy/3"===a?c.start(3):"spdy/2"===a&&c.start(2);c.on("error",function(){b.destroy()});
var d=this;c.on("stream",function(a){d._onStream(a)})};var PREFACE="PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n",PREFACE_BUFFER=new Buffer(PREFACE);function hoseFilter(b,a){if(1>b.length)return a(null,null);if(128===b[0])return a(null,"spdy");for(var c=Math.min(b.length,PREFACE_BUFFER.length),d=0;d<c;d++)if(b[d]!==PREFACE_BUFFER[d])return a(null,"http/1.1");return c!==PREFACE_BUFFER.length?a(null,null):a(null,"h2")}
proto._onPlainConnection=function(b){var a=selectHose.create(b,{},hoseFilter),c=this;a.on("select",function(a,b){c._handleConnection(b,a)});a.on("error",function(a){debug("hose error %j",a.message);b.destroy()})};proto._invokeDefault=function(b){for(var a=this._spdyState,c=0;c<a.listeners.length;c++)a.listeners[c].call(this,b)};
proto._onStream=function(b){var a=this._spdyState,c=spdy.handle.create(this._spdyState.options,b),d={handle:c,allowHalfOpen:!0},a=a.secure?new spdy.Socket(b.connection.socket,d):new net.Socket(d);c.assignSocket(a);a.readable=!0;a.writable=!0;this._invokeDefault(a);if(void 0!==b.headers.expect&&/100-continue/i.test(b.headers.expect)&&0===EventEmitter.listenerCount(this,"checkContinue"))this.once("checkContinue",function(a,b){b.writeContinue();this.emit("request",a,b)});c.emitRequest()};
proto.emit=function(b,a,c){if("request"!==b&&"checkContinue"!==b)return EventEmitter.prototype.emit.apply(this,arguments);if(!(a.socket._handle instanceof spdy.handle))return debug("not spdy req/res"),a.isSpdy=!1,a.spdyVersion=1,c.isSpdy=!1,c.spdyVersion=1,EventEmitter.prototype.emit.apply(this,arguments);var d=a.connection._handle;a.isSpdy=!0;a.spdyVersion=d.getStream().connection.getVersion();c.isSpdy=!0;c.spdyVersion=a.spdyVersion;a.spdyStream=d.getStream();debug("override req/res");c.writeHead=
spdy.response.writeHead;c.end=spdy.response.end;c.push=spdy.response.push;c.writeContinue=spdy.response.writeContinue;c.spdyStream=d.getStream();c._req=a;d.assignRequest(a);d.assignResponse(c);return EventEmitter.prototype.emit.apply(this,arguments)};exports.Server=instantiate(https.Server);exports.PlainServer=instantiate(http.Server);
exports.create=function(b,a,c){"object"===typeof b&&(c=a,a=b,b=null);return b?instantiate(b).create(a,c):a.spdy&&a.spdy.plain?exports.PlainServer.create(a,c):exports.Server.create(a,c)}; //# sourceMappingURL=server.js.map
